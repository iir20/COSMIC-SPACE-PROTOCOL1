<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My NFT Collection - Cosmic Space Protocol</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="nft.css">
    <style>
        .collection-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(20, 20, 40, 0.8);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-card i {
            font-size: 2em;
            color: #5b5be6;
            margin-bottom: 10px;
        }

        .stat-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .stat-value {
            color: #fff;
            font-size: 1.5em;
            font-weight: 600;
        }

        .list-button {
            background: #28a745;
            color: white;
        }

        .list-button:hover {
            background: #218838;
        }

        .stake-button {
            background: #17a2b8;
            color: white;
        }

        .stake-button:hover {
            background: #138496;
        }

        .listing-form {
            margin-top: 20px;
        }

        .listing-form .form-group {
            margin-bottom: 15px;
        }

        .listing-form label {
            display: block;
            margin-bottom: 5px;
            color: rgba(255, 255, 255, 0.8);
        }

        .listing-form input {
            width: 100%;
            padding: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .listing-form input:focus {
            outline: none;
            border-color: #5b5be6;
        }

        .staking-info {
            margin-top: 20px;
            padding: 15px;
            background: rgba(23, 162, 184, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(23, 162, 184, 0.2);
        }

        .staking-info h4 {
            color: #17a2b8;
            margin-bottom: 10px;
        }

        .staking-info p {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 5px;
        }

        .staking-rewards {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .reward-token {
            color: #ffc107;
        }
    </style>
</head>
<body class="cosmic-theme">
    <!-- Background Elements -->
    <div class="cosmic-background"></div>
    <div id="stars" class="stars"></div>
    <div id="nebula" class="nebula"></div>
    <div id="aurora" class="aurora"></div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="cosmic-loading-overlay">
        <div class="cosmic-spinner"></div>
        <p>Loading Collection...</p>
    </div>
    
    <div class="container">
    <header class="main-header">
        <div class="header-content">
                <h1 class="cosmic-title">My NFT Collection</h1>
                <p class="header-subtitle">Manage your Cosmic Space NFTs</p>
            </div>

            <nav class="cosmic-nav">
                <a href="nft-marketplace.html" class="cosmic-nav-item">
                    <i class="fas fa-store"></i>
                    <span>Marketplace</span>
                </a>
                <a href="nft-mint.html" class="cosmic-nav-item">
                    <i class="fas fa-magic"></i>
                    <span>Mint NFT</span>
                </a>
                <a href="nft-staking.html" class="cosmic-nav-item">
                    <i class="fas fa-layer-group"></i>
                    <span>NFT Staking</span>
                </a>
            </nav>

            <div class="wallet-section">
                <button class="cosmic-button primary wallet-connect" id="wallet-connect-btn">
                    <i class="fas fa-wallet"></i>
                    <span>Connect Wallet</span>
                </button>
                <div class="wallet-info" style="display: none;">
                    <div class="balance-item">
                    <i class="fas fa-coins"></i>
                    <span id="xcis-balance">0.00</span>
                    <span class="currency">xCIS</span>
                    </div>
            </div>
        </div>
    </header>

        <main>
            <!-- Collection Stats -->
            <section class="collection-stats">
                <div class="stat-card">
                    <i class="fas fa-image"></i>
                    <div class="stat-info">
                        <div class="stat-label">Total NFTs</div>
                        <div class="stat-value" id="total-nfts">0</div>
                    </div>
                            </div>
                <div class="stat-card">
                    <i class="fas fa-tag"></i>
                            <div class="stat-info">
                        <div class="stat-label">Listed NFTs</div>
                        <div class="stat-value" id="listed-nfts">0</div>
                    </div>
                </div>
                <div class="stat-card">
                            <i class="fas fa-layer-group"></i>
                    <div class="stat-info">
                        <div class="stat-label">Staked NFTs</div>
                        <div class="stat-value" id="staked-nfts">0</div>
                    </div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-chart-line"></i>
                    <div class="stat-info">
                        <div class="stat-label">Total Value</div>
                        <div class="stat-value" id="total-value">0 xCIS</div>
                    </div>
                </div>
            </section>

            <!-- Filters -->
            <section class="filters">
                <div class="filter-group">
                    <div class="filter-item">
                        <label class="filter-label">Type</label>
                        <select class="cosmic-select" id="filter-type">
                            <option value="">All Types</option>
                            <option value="Planet">Planets</option>
                            <option value="Star">Stars</option>
                            <option value="Galaxy">Galaxies</option>
                            <option value="BlackHole">Black Holes</option>
                            <option value="Nebula">Nebulas</option>
                            <option value="Comet">Comets</option>
                            <option value="Asteroid">Asteroids</option>
                            <option value="Satellite">Satellites</option>
                    </select>
                    </div>
                    <div class="filter-item">
                        <label class="filter-label">Rarity</label>
                        <select class="cosmic-select" id="filter-rarity">
                        <option value="">All Rarities</option>
                        <option value="common">Common</option>
                        <option value="uncommon">Uncommon</option>
                        <option value="rare">Rare</option>
                        <option value="epic">Epic</option>
                        <option value="legendary">Legendary</option>
                    </select>
                    </div>
                    <div class="filter-item">
                        <label class="filter-label">Status</label>
                        <select class="cosmic-select" id="filter-status">
                            <option value="">All Status</option>
                            <option value="available">Available</option>
                            <option value="listed">Listed</option>
                            <option value="staked">Staked</option>
                    </select>
                    </div>
                </div>
            </section>

            <!-- NFT Grid -->
            <section class="marketplace-grid" id="nft-collection">
                <!-- NFTs will be loaded here -->
            </section>
        </main>

        <footer class="cosmic-footer">
            <p>&copy; 2024 COSMIC Space Protocol. All rights reserved.</p>
        </footer>
    </div>

    <!-- NFT Details Modal -->
    <div id="nft-details-modal" class="cosmic-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>NFT Details</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="nft-details">
                    <img id="modal-nft-image" src="" alt="NFT" class="nft-image">
                    <h3 id="modal-nft-name"></h3>
                    <div id="modal-nft-attributes"></div>
                    
                    <div id="listing-section" style="display: none;">
                        <div class="listing-form">
                            <div class="form-group">
                                <label for="listing-price">Listing Price (xCIS)</label>
                                <input type="number" id="listing-price" min="0" step="0.1" placeholder="Enter price">
                            </div>
                        </div>
                            </div>

                    <div id="staking-section" style="display: none;">
                        <div class="staking-info">
                            <h4>Staking Information</h4>
                            <p>Current APR: <span id="staking-apr">0</span>%</p>
                            <p>Rewards Earned: <span id="staking-rewards">0</span> xCIS</p>
                            <div class="staking-rewards">
                                <i class="fas fa-coins reward-token"></i>
                                <span id="daily-reward">0</span> xCIS / day
                            </div>
                        </div>
                    </div>

                    <div class="action-buttons" id="modal-actions">
                        <!-- Action buttons will be added here -->
                                </div>
                                </div>
                            </div>
                        </div>
                    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/web3@1.5.2/dist/web3.min.js"></script>
    <script src="blockchain.js"></script>
    <script src="cisp-wallet.js"></script>
    <script src="wallet-config.js"></script>
    <script src="wallet-manager.js"></script>
    <script src="notifications.js"></script>
    <script src="nft-system.js"></script>
    <script src="nft-marketplace.js"></script>
    <script src="cosmic-ui.js"></script>
    <script src="wallet-sync.js"></script>
    <script src="cosmic-functions.js"></script>
    <script src="cosmic-integration.js"></script>
    <script src="enhanced-cosmic-effects.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.style.display = 'flex';

            try {
                // Initialize systems
                await initializeSystems();
                
                // Load initial data
                await loadCollectionData();

                // Setup event listeners
                setupEventListeners();

            } catch (error) {
                console.error('Error initializing collection:', error);
                if (window.notifications) {
                    window.notifications.show('error', 'Failed to initialize collection');
                }
            } finally {
                loadingOverlay.style.display = 'none';
            }
        });

        async function initializeSystems() {
            // Initialize notification system
            if (!window.notifications) {
                console.warn('Notification system not found');
            }

            // Initialize wallet system
            if (window.cispWallet) {
                try {
                    await window.cispWallet.init();
                    const wallet = window.cispWallet.getCurrentWallet();
                    if (wallet) {
                        updateWalletDisplay(wallet);
                    }
                } catch (error) {
                    console.warn('Wallet initialization error:', error);
                }
            }

            // Initialize NFT system
            if (!window.nftSystem) {
                throw new Error('NFT system not found');
            }
            await window.nftSystem.initialize();
        }

        async function loadCollectionData() {
            const wallet = window.cispWallet?.getCurrentWallet();
            if (!wallet) {
                displayEmptyState('Please connect your wallet to view your collection');
                return;
            }

            // Load collection stats
            const stats = await window.nftSystem.getCollectionStats(wallet.address);
            updateCollectionStats(stats);

            // Load NFTs with current filters
            await updateCollection();
        }

        function updateCollectionStats(stats) {
            document.getElementById('total-nfts').textContent = stats.total || 0;
            document.getElementById('listed-nfts').textContent = stats.listed || 0;
            document.getElementById('staked-nfts').textContent = stats.staked || 0;
            document.getElementById('total-value').textContent = `${stats.totalValue || 0} xCIS`;
        }

        function setupEventListeners() {
            // Filter change events
            document.getElementById('filter-type').addEventListener('change', updateCollection);
            document.getElementById('filter-rarity').addEventListener('change', updateCollection);
            document.getElementById('filter-status').addEventListener('change', updateCollection);

            // Wallet connect button
            const connectBtn = document.getElementById('wallet-connect-btn');
            if (connectBtn) {
                connectBtn.addEventListener('click', connectWallet);
            }

            // Modal close buttons
            document.querySelectorAll('.close-modal').forEach(button => {
                button.addEventListener('click', () => {
                    const modal = button.closest('.cosmic-modal');
                    if (modal) modal.style.display = 'none';
                });
            });

            // NFT system event listeners
            window.nftSystem.addListener((event, data) => {
                switch (event) {
                    case 'transfer':
                    case 'list':
                    case 'unlist':
                    case 'stake':
                    case 'unstake':
                        loadCollectionData();
                        break;
                }
            });
        }

        async function updateCollection() {
            const wallet = window.cispWallet?.getCurrentWallet();
            if (!wallet) {
                displayEmptyState('Please connect your wallet to view your collection');
                return;
            }

            const filters = {
                type: document.getElementById('filter-type').value,
                rarity: document.getElementById('filter-rarity').value,
                status: document.getElementById('filter-status').value
            };

            const nfts = await window.nftSystem.getNFTs(wallet.address, filters);
            displayCollection(nfts);
        }

        function displayCollection(nfts) {
            const container = document.getElementById('nft-collection');
            container.innerHTML = '';

            if (!nfts || nfts.length === 0) {
                displayEmptyState('No NFTs found matching your filters');
                return;
            }

            nfts.forEach(nft => {
                const card = createNFTCard(nft);
                container.appendChild(card);
            });
        }

        function createNFTCard(nft) {
                const card = document.createElement('div');
            card.className = 'nft-card';
                card.innerHTML = `
                <img src="images/${nft.type}-${nft.rarity}-1.png" 
                     class="nft-image" alt="${nft.name}">
                    <div class="nft-info">
                    <div class="nft-name">${nft.name}</div>
                    <div class="nft-meta">
                        <span class="rarity-badge rarity-${nft.rarity.toLowerCase()}">
                            ${nft.rarity}
                            </span>
                        <span>${nft.status}</span>
                    </div>
                    <div class="action-buttons">
                        <button class="cosmic-button primary" onclick="showNFTDetails('${nft.tokenId}')">
                            Manage NFT
                        </button>
                    </div>
                    </div>
                `;
            return card;
        }

        function displayEmptyState(message) {
            const container = document.getElementById('nft-collection');
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-folder-open"></i>
                    <p>${message}</p>
                </div>
            `;
        }

        async function showNFTDetails(tokenId) {
            const nft = await window.nftSystem.getNFT(tokenId);
            if (!nft) return;

            const modal = document.getElementById('nft-details-modal');
            const image = document.getElementById('modal-nft-image');
            const name = document.getElementById('modal-nft-name');
            const attributes = document.getElementById('modal-nft-attributes');
            const actions = document.getElementById('modal-actions');
            const listingSection = document.getElementById('listing-section');
            const stakingSection = document.getElementById('staking-section');

            image.src = `images/${nft.type}-${nft.rarity}-1.png`;
            name.textContent = nft.name;

            // Display attributes
            attributes.innerHTML = `
                <div class="attribute-grid">
                    <div class="attribute">
                        <span class="label">Type:</span>
                        <span class="value">${nft.type}</span>
                    </div>
                    <div class="attribute">
                        <span class="label">Rarity:</span>
                        <span class="value ${nft.rarity.toLowerCase()}">${nft.rarity}</span>
                    </div>
                    <div class="attribute">
                        <span class="label">Status:</span>
                        <span class="value">${nft.status}</span>
                    </div>
                    <div class="attribute">
                        <span class="label">Token ID:</span>
                        <span class="value">${tokenId}</span>
                    </div>
                </div>
            `;

            // Setup action buttons based on NFT status
            actions.innerHTML = '';
            listingSection.style.display = 'none';
            stakingSection.style.display = 'none';

            switch (nft.status.toLowerCase()) {
                case 'available':
                    listingSection.style.display = 'block';
                    stakingSection.style.display = 'block';
                    actions.innerHTML = `
                        <button class="cosmic-button list-button" onclick="listNFT('${tokenId}')">
                            List for Sale
                        </button>
                        <button class="cosmic-button stake-button" onclick="stakeNFT('${tokenId}')">
                            Stake NFT
                        </button>
                    `;
                    break;

                case 'listed':
                    const listing = await window.nftMarketplace.getListing(tokenId);
                    if (listing) {
                        actions.innerHTML = `
                            <div class="nft-price">${listing.price} xCIS</div>
                            <button class="cosmic-button cancel-button" onclick="cancelListing('${tokenId}')">
                                Cancel Listing
                            </button>
                        `;
                    }
                    break;

                case 'staked':
                    stakingSection.style.display = 'block';
                    const stakingInfo = await window.nftSystem.getStakingInfo(tokenId);
                    if (stakingInfo) {
                        document.getElementById('staking-apr').textContent = stakingInfo.apr;
                        document.getElementById('staking-rewards').textContent = stakingInfo.rewards;
                        document.getElementById('daily-reward').textContent = stakingInfo.dailyReward;
                    }
                    actions.innerHTML = `
                        <button class="cosmic-button cancel-button" onclick="unstakeNFT('${tokenId}')">
                            Unstake NFT
                        </button>
                    `;
                    break;
            }

            modal.style.display = 'flex';
        }

        async function listNFT(tokenId) {
            const price = document.getElementById('listing-price').value;
            if (!price || price <= 0) {
                if (window.notifications) {
                    window.notifications.show('error', 'Please enter a valid price');
                }
                return;
            }

            try {
                await window.nftMarketplace.listNFT(tokenId, price);
                            if (window.notifications) {
                    window.notifications.show('success', 'NFT listed successfully');
                            }
                document.getElementById('nft-details-modal').style.display = 'none';
                await loadCollectionData();
                    } catch (error) {
                console.error('Error listing NFT:', error);
                        if (window.notifications) {
                    window.notifications.show('error', error.message);
                }
            }
        }

        async function cancelListing(tokenId) {
            try {
                await window.nftMarketplace.cancelListing(tokenId);
                if (window.notifications) {
                    window.notifications.show('success', 'Listing cancelled successfully');
                }
                document.getElementById('nft-details-modal').style.display = 'none';
                await loadCollectionData();
            } catch (error) {
                console.error('Error cancelling listing:', error);
                if (window.notifications) {
                    window.notifications.show('error', error.message);
                }
            }
        }

        async function stakeNFT(tokenId) {
            try {
                await window.nftSystem.stakeNFT(tokenId);
                if (window.notifications) {
                    window.notifications.show('success', 'NFT staked successfully');
                }
                document.getElementById('nft-details-modal').style.display = 'none';
                await loadCollectionData();
            } catch (error) {
                console.error('Error staking NFT:', error);
                if (window.notifications) {
                    window.notifications.show('error', error.message);
                }
            }
        }

        async function unstakeNFT(tokenId) {
            try {
                await window.nftSystem.unstakeNFT(tokenId);
                if (window.notifications) {
                    window.notifications.show('success', 'NFT unstaked successfully');
                }
                document.getElementById('nft-details-modal').style.display = 'none';
                await loadCollectionData();
            } catch (error) {
                console.error('Error unstaking NFT:', error);
                if (window.notifications) {
                    window.notifications.show('error', error.message);
                }
            }
        }

        async function connectWallet() {
            try {
                if (window.cispWallet) {
                    await window.cispWallet.connect();
                    const wallet = window.cispWallet.getCurrentWallet();
                    if (wallet) {
                        updateWalletDisplay(wallet);
                        await loadCollectionData();
                    }
                }
            } catch (error) {
                console.error('Error connecting wallet:', error);
                if (window.notifications) {
                    window.notifications.show('error', 'Failed to connect wallet');
                }
            }
        }

        function updateWalletDisplay(wallet) {
            const connectBtn = document.getElementById('wallet-connect-btn');
            const walletInfo = document.querySelector('.wallet-info');
            
            if (wallet) {
                connectBtn.style.display = 'none';
                walletInfo.style.display = 'flex';
                document.getElementById('xcis-balance').textContent = formatNumber(wallet.balance);
            } else {
                connectBtn.style.display = 'flex';
                walletInfo.style.display = 'none';
            }
        }

        function formatNumber(num) {
            return parseFloat(num).toFixed(2);
        }
    </script>
</body>
</html> 